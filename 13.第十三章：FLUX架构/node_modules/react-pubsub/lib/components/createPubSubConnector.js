'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createPubSubConnector;

var _react = require('react');

var _hoistNonReactStatics = require('hoist-non-react-statics');

var _hoistNonReactStatics2 = _interopRequireDefault(_hoistNonReactStatics);

var _isPlainObject = require('../utils/isPlainObject');

var _isPlainObject2 = _interopRequireDefault(_isPlainObject);

var _shallowEqual = require('../utils/shallowEqual');

var _shallowEqual2 = _interopRequireDefault(_shallowEqual);

var _pubSubShape = require('../shapes/pubSubShape');

var _pubSubShape2 = _interopRequireDefault(_pubSubShape);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var defaultMapPublishToProps = function defaultMapPublishToProps(publish) {
  return { publish: publish };
};
var defaultMapSubscriptionsToProps = function defaultMapSubscriptionsToProps() {
  return {};
};
var defaultInitMapSubscriptionsToProps = function defaultInitMapSubscriptionsToProps() {
  return defaultMapSubscriptionsToProps;
};

function getDisplayName(WrappedComponent) {
  return WrappedComponent.displayName || WrappedComponent.name || 'Component';
}

function cleanEmptyKeys() {
  var obj = arguments.length <= 0 || arguments[0] === void 0 ? {} : arguments[0];

  Object.keys(obj).filter(function (key) {
    return obj[key] === void 0 || obj[key] === null;
  }).forEach(function (key) {
    return delete obj[key];
  });
  return obj;
}

function wrapSubscritionsMap(mapSubscriptionsToProps) {
  var validMappedSubscriptions = Object.keys(mapSubscriptionsToProps).every(function (key) {
    return typeof mapSubscriptionsToProps[key] === 'function' || typeof mapSubscriptionsToProps[key] === 'string';
  });

  if (!validMappedSubscriptions) {
    throw new Error('Every mapped Subscription of "createPubSubConnector" must be a function' + 'returning the value to be passed as prop to the decorated component.');
  }

  return function (pubSub, notifyChange, getProps) {
    var add = pubSub.add;

    var map = {};

    var updateStoredMapFromObject = function updateStoredMapFromObject(updatedValue) {
      var updatedMap = {};
      var keysToUpdate = Object.keys(updatedValue).filter(function (key) {
        if (map.hasOwnProperty(key)) {
          if (updatedValue[key] && (0, _shallowEqual2.default)(map[key], updatedValue[key])) {
            return false;
          }
        }
        updatedMap[key] = updatedValue[key];
        return true;
      });

      if (keysToUpdate.length) {
        map = cleanEmptyKeys(_extends({}, map, updatedMap));
        return true;
      }
      return false;
    };

    var updateStoredMapFromKey = function updateStoredMapFromKey(key, updatedValue) {
      if (map.hasOwnProperty(key)) {
        if (updatedValue && (0, _shallowEqual2.default)(map[key], updatedValue)) {
          return false;
        }
      }
      map = cleanEmptyKeys(_extends({}, map, _defineProperty({}, key, updatedValue)));
      return true;
    };

    Object.keys(mapSubscriptionsToProps).forEach(function (key) {
      var transformerOrAlias = mapSubscriptionsToProps[key];
      if (typeof transformerOrAlias === 'function') {
        add(key, function () {
          for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
            args[_key] = arguments[_key];
          }

          var updatedValue = transformerOrAlias.apply(void 0, args.concat([getProps()]));
          if (updateStoredMapFromObject(updatedValue)) {
            notifyChange();
          }
        });
      } else {
        add(key, function (payload) {
          if (updateStoredMapFromKey(transformerOrAlias, payload)) {
            notifyChange();
          }
        });
      }
    });

    return function () {
      return map;
    };
  };
}

function wrapPublishMethods(mapPublishToProps) {
  return function (publish) {
    return Object.keys(mapPublishToProps).filter(function (key) {
      return typeof mapPublishToProps[key] === 'function';
    }).reduce(function (acc, key) {
      acc[key] = function () {
        for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
          args[_key2] = arguments[_key2];
        }

        return mapPublishToProps[key].apply(mapPublishToProps, [publish].concat(args));
      };
      return acc;
    }, {});
  };
}

function createPubSubConnector(mapSubscriptionsToProps, mapPublishToProps) {
  var options = arguments.length <= 2 || arguments[2] === void 0 ? {} : arguments[2];

  if (mapSubscriptionsToProps && typeof mapSubscriptionsToProps !== 'function' && !(0, _isPlainObject2.default)(mapSubscriptionsToProps)) {
    throw new Error('"createPubSubConnector" expected "mapSubscriptionsToProps" to be a function' + (' or a plain object, instead received: ' + mapSubscriptionsToProps + '.'));
  }
  var shouldMapSubscriptions = (0, _isPlainObject2.default)(mapSubscriptionsToProps) ? Object.keys(mapSubscriptionsToProps).length : Boolean(mapSubscriptionsToProps);

  var finalMapSubscriptionsToProps = defaultMapSubscriptionsToProps;
  var doSubscribedPropsDependOnOwnProps = false;

  var finalMapPublishToProps = (0, _isPlainObject2.default)(mapPublishToProps) ? wrapPublishMethods(mapPublishToProps) : mapPublishToProps || defaultMapPublishToProps;
  var doPublishPropsDependOnOwnProps = finalMapPublishToProps.length > 1;

  var _ref = options || {};

  var _ref$withRef = _ref.withRef;
  var withRef = _ref$withRef === void 0 ? false : _ref$withRef;

  function initComputeSubscribedProps(pubSub, notifier, getProps) {
    var subscriber = void 0;
    if ((0, _isPlainObject2.default)(mapSubscriptionsToProps)) {
      subscriber = wrapSubscritionsMap(mapSubscriptionsToProps);
    } else {
      subscriber = mapSubscriptionsToProps || defaultInitMapSubscriptionsToProps;
    }
    finalMapSubscriptionsToProps = subscriber(pubSub, notifier, getProps);
    doSubscribedPropsDependOnOwnProps = finalMapSubscriptionsToProps.length > 0;
  }

  function computeSubscribedProps(props) {
    var subscribedProps = doSubscribedPropsDependOnOwnProps ? finalMapSubscriptionsToProps(props) : finalMapSubscriptionsToProps();

    if (!(0, _isPlainObject2.default)(subscribedProps)) {
      throw new Error('\'mapSubscriptionsToProps\' must return an object.' + ('Instead received ' + subscribedProps));
    }
    return subscribedProps;
  }

  function computePublishProps(pubSub, props) {
    var publish = pubSub.publish;

    var publishProps = doPublishPropsDependOnOwnProps ? finalMapPublishToProps(publish, props) : finalMapPublishToProps(publish);

    if (!(0, _isPlainObject2.default)(publishProps)) {
      throw new Error('\'mapPublishToProps\' must return an object.' + ('Instead received ' + publishProps));
    }
    return publishProps;
  }

  return function wrapComponent(Composed) {
    var PubSubConnector = function (_Component) {
      _inherits(PubSubConnector, _Component);

      function PubSubConnector(props, context) {
        _classCallCheck(this, PubSubConnector);

        var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(PubSubConnector).call(this, props, context));

        _this.pubSubCore = props.pubSubCore || context.pubSubCore;

        if (!_this.pubSubCore) {
          throw new Error('Could not find "pubSubCore" in either the context or ' + ('props of "' + _this.constructor.displayName + '". ') + 'Either wrap the root component in a <PubSubProvider>, ' + ('or explicitly pass "pubSubCore" as a prop to "' + _this.constructor.displayName + '".'));
        }
        _this.state = {};
        _this.pubSub = _this.pubSubCore.register(_this);
        return _this;
      }

      _createClass(PubSubConnector, [{
        key: 'componentWillMount',
        value: function componentWillMount() {
          this.trySubscribe();
        }
      }, {
        key: 'componentWillReceiveProps',
        value: function componentWillReceiveProps(nextProps) {
          if (!(0, _shallowEqual2.default)(nextProps, this.props)) {
            this.haveOwnPropsChanged = true;
          }
        }
      }, {
        key: 'shouldComponentUpdate',
        value: function shouldComponentUpdate() {
          return this.haveOwnPropsChanged || this.hasSubscribedPropsChanged;
        }
      }, {
        key: 'componentWillUnmount',
        value: function componentWillUnmount() {
          this.pubSub.unsubscribe();
        }
      }, {
        key: 'getWrappedInstance',
        value: function getWrappedInstance() {
          if (!withRef) {
            throw new Error('To access the wrapped instance, you need to specify explicitly' + ' { withRef: true } in the options passed to the createPubSubConnector() call.');
          }
          return this.refs.wrappedInstance;
        }
      }, {
        key: 'hasSubscriptions',
        value: function hasSubscriptions() {
          if (this.pubSub) {
            return this.pubSub.subscriptions.length ? true : false;
          }
          return false;
        }
      }, {
        key: 'notifyChange',
        value: function notifyChange() {
          var prevSubscribedProps = this.state.subscribedProps;
          var subscribedProps = finalMapSubscriptionsToProps(this.props);

          if (prevSubscribedProps !== subscribedProps) {
            this.hasSubscribedPropsChanged = true;
            this.setState({ subscribedProps: subscribedProps });
          }
        }
      }, {
        key: 'trySubscribe',
        value: function trySubscribe() {
          var _this2 = this;

          if (shouldMapSubscriptions) {
            initComputeSubscribedProps(this.pubSub, function () {
              return _this2.notifyChange();
            }, function () {
              return _this2.props;
            });
            this.notifyChange();
          }
        }
      }, {
        key: 'updateSubscribedPropsIfNeeded',
        value: function updateSubscribedPropsIfNeeded() {
          var nextSubscribedProps = computeSubscribedProps(this.props);
          if (this.subscribedProps && (0, _shallowEqual2.default)(nextSubscribedProps, this.subscribedProps)) {
            return false;
          }

          this.subscribedProps = nextSubscribedProps;
          return true;
        }
      }, {
        key: 'updatePublishPropsIfNeeded',
        value: function updatePublishPropsIfNeeded() {
          var nextPublishProps = computePublishProps(this.pubSub, this.props);
          if (this.publishProps && (0, _shallowEqual2.default)(nextPublishProps, this.publishProps)) {
            return false;
          }

          this.publishProps = nextPublishProps;
          return true;
        }
      }, {
        key: 'render',
        value: function render() {
          var haveOwnPropsChanged = this.haveOwnPropsChanged;
          var hasSubscribedPropsChanged = this.hasSubscribedPropsChanged;
          var renderedElement = this.renderedElement;
          var pubSub = this.pubSub;

          this.haveOwnPropsChanged = false;
          this.hasSubscribedPropsChanged = false;

          var shouldUpdateSubscribedProps = true;
          var shouldUpdatePublishProps = true;
          if (renderedElement) {
            shouldUpdateSubscribedProps = hasSubscribedPropsChanged || haveOwnPropsChanged && doSubscribedPropsDependOnOwnProps;
            shouldUpdatePublishProps = haveOwnPropsChanged && doPublishPropsDependOnOwnProps;
          }

          var haveSubscribedPropsChanged = false;
          var havePublishPropsChanged = false;
          if (shouldUpdateSubscribedProps) {
            haveSubscribedPropsChanged = this.updateSubscribedPropsIfNeeded();
          }
          if (shouldUpdatePublishProps) {
            havePublishPropsChanged = this.updatePublishPropsIfNeeded();
          }

          if (!haveSubscribedPropsChanged && !havePublishPropsChanged && !haveOwnPropsChanged && renderedElement) {
            return renderedElement;
          }

          var baseProps = { pubSub: pubSub };
          if (withRef) {
            _extends(baseProps, { ref: 'wrappedInstance' });
          }

          var mergedProps = _extends({}, this.props, this.subscribedProps, this.publishProps, baseProps);

          this.renderedElement = (0, _react.createElement)(Composed, mergedProps);

          return this.renderedElement;
        }
      }]);

      return PubSubConnector;
    }(_react.Component);

    PubSubConnector.contextTypes = {
      pubSubCore: _pubSubShape2.default
    };

    PubSubConnector.propTypes = {
      pubSubCore: _pubSubShape2.default
    };

    PubSubConnector.displayName = 'PubSubConnector(' + getDisplayName(Composed) + ')';
    PubSubConnector.WrappedComponent = Composed;

    return (0, _hoistNonReactStatics2.default)(PubSubConnector, Composed);
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb25lbnRzL2NyZWF0ZVB1YlN1YkNvbm5lY3Rvci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7a0JBc0d3Qjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaEd4QixJQUFNLDJCQUEyQixTQUEzQix3QkFBMkI7U0FBWSxFQUFFLGdCQUFGO0NBQVo7QUFDakMsSUFBTSxpQ0FBaUMsU0FBakMsOEJBQWlDO1NBQU87Q0FBUDtBQUN2QyxJQUFNLHFDQUFxQyxTQUFyQyxrQ0FBcUM7U0FBTTtDQUFOOztBQUUzQyxTQUFTLGNBQVQsQ0FBd0IsZ0JBQXhCLEVBQTBDO0FBQ3hDLFNBQU8saUJBQWlCLFdBQWpCLElBQWdDLGlCQUFpQixJQUFqQixJQUF5QixXQUF6RCxDQURpQztDQUExQzs7QUFJQSxTQUFTLGNBQVQsR0FBa0M7TUFBVix5REFBTSxrQkFBSTs7QUFDaEMsU0FBTyxJQUFQLENBQVksR0FBWixFQUNDLE1BREQsQ0FDUTtXQUFPLElBQUksR0FBSixnQkFBMEIsSUFBSSxHQUFKLE1BQWEsSUFBYjtHQUFqQyxDQURSLENBRUMsT0FGRCxDQUVTO1dBQU8sT0FBTyxJQUFJLEdBQUosQ0FBUDtHQUFQLENBRlQsQ0FEZ0M7QUFJaEMsU0FBTyxHQUFQLENBSmdDO0NBQWxDOztBQU9BLFNBQVMsbUJBQVQsQ0FBNkIsdUJBQTdCLEVBQXNEO0FBQ3BELE1BQU0sMkJBQTJCLE9BQU8sSUFBUCxDQUFZLHVCQUFaLEVBQ2hDLEtBRGdDLENBRS9CO1dBQVEsT0FBTyx3QkFBd0IsR0FBeEIsQ0FBUCxLQUF3QyxVQUF4QyxJQUNBLE9BQU8sd0JBQXdCLEdBQXhCLENBQVAsS0FBd0MsUUFBeEM7R0FEUixDQUZJLENBRDhDOztBQU9wRCxNQUFJLENBQUMsd0JBQUQsRUFBMkI7QUFDN0IsVUFBTSxJQUFJLEtBQUosQ0FDSixrSkFESSxDQUFOLENBRDZCO0dBQS9COztBQU9BLFNBQU8sVUFBQyxNQUFELEVBQVMsWUFBVCxFQUF1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LHFCQUFjLFNBQWQsRUFBeUIsRUFBRSxLQUFLLGlCQUFMLEVBQTNCLEVBRFc7V0FBYjs7QUFJQSxjQUFNLGNBQWMsU0FDbEIsRUFEa0IsRUFFbEIsS0FBSyxLQUFMLEVBQ0EsS0FBSyxlQUFMLEVBQ0EsS0FBSyxZQUFMLEVBQ0EsU0FMa0IsQ0FBZCxDQTFDQzs7QUFrRFAsZUFBSyxlQUFMLEdBQXVCLDBCQUFjLFFBQWQsRUFBd0IsV0FBeEIsQ0FBdkIsQ0FsRE87O0FBb0RQLGlCQUFPLEtBQUssZUFBTCxDQXBEQTs7OzthQTVGTDt3QkFEZ0M7O0FBcUp0QyxvQkFBZ0IsWUFBaEIsR0FBK0I7QUFDN0IsdUNBRDZCO0tBQS9CLENBckpzQzs7QUF5SnRDLG9CQUFnQixTQUFoQixHQUE0QjtBQUMxQix1Q0FEMEI7S0FBNUIsQ0F6SnNDOztBQTZKdEMsb0JBQWdCLFdBQWhCLHdCQUFpRCxlQUFlLFFBQWYsT0FBakQsQ0E3SnNDO0FBOEp0QyxvQkFBZ0IsZ0JBQWhCLEdBQW1DLFFBQW5DLENBOUpzQzs7QUFnS3RDLFdBQU8sb0NBQWEsZUFBYixFQUE4QixRQUE5QixDQUFQLENBaEtzQztHQUFqQyxDQTdEUDtDQUphIiwiZmlsZSI6ImNyZWF0ZVB1YlN1YkNvbm5lY3Rvci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgY3JlYXRlRWxlbWVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBob2lzdFN0YXRpY3MgZnJvbSAnaG9pc3Qtbm9uLXJlYWN0LXN0YXRpY3MnO1xuaW1wb3J0IGlzUGxhaW5PYmplY3QgZnJvbSAnLi4vdXRpbHMvaXNQbGFpbk9iamVjdCc7XG5pbXBvcnQgc2hhbGxvd0VxdWFsIGZyb20gJy4uL3V0aWxzL3NoYWxsb3dFcXVhbCc7XG5pbXBvcnQgcHViU3ViU2hhcGUgZnJvbSAnLi4vc2hhcGVzL3B1YlN1YlNoYXBlJztcblxuY29uc3QgZGVmYXVsdE1hcFB1Ymxpc2hUb1Byb3BzID0gcHVibGlzaCA9PiAoeyBwdWJsaXNoIH0pO1xuY29uc3QgZGVmYXVsdE1hcFN1YnNjcmlwdGlvbnNUb1Byb3BzID0gKCkgPT4gKHt9KTtcbmNvbnN0IGRlZmF1bHRJbml0TWFwU3Vic2NyaXB0aW9uc1RvUHJvcHMgPSAoKSA9PiBkZWZhdWx0TWFwU3Vic2NyaXB0aW9uc1RvUHJvcHM7XG5cbmZ1bmN0aW9uIGdldERpc3BsYXlOYW1lKFdyYXBwZWRDb21wb25lbnQpIHtcbiAgcmV0dXJuIFdyYXBwZWRDb21wb25lbnQuZGlzcGxheU5hbWUgfHwgV3JhcHBlZENvbXBvbmVudC5uYW1lIHx8ICdDb21wb25lbnQnO1xufVxuXG5mdW5jdGlvbiBjbGVhbkVtcHR5S2V5cyhvYmogPSB7fSkge1xuICBPYmplY3Qua2V5cyhvYmopXG4gIC5maWx0ZXIoa2V5ID0+IG9ialtrZXldID09PSB1bmRlZmluZWQgfHwgb2JqW2tleV0gPT09IG51bGwpXG4gIC5mb3JFYWNoKGtleSA9PiBkZWxldGUgb2JqW2tleV0pO1xuICByZXR1cm4gb2JqO1xufVxuXG5mdW5jdGlvbiB3cmFwU3Vic2NyaXRpb25zTWFwKG1hcFN1YnNjcmlwdGlvbnNUb1Byb3BzKSB7XG4gIGNvbnN0IHZhbGlkTWFwcGVkU3Vic2NyaXB0aW9ucyA9IE9iamVjdC5rZXlzKG1hcFN1YnNjcmlwdGlvbnNUb1Byb3BzKVxuICAuZXZlcnkoXG4gICAga2V5ID0+ICh0eXBlb2YgbWFwU3Vic2NyaXB0aW9uc1RvUHJvcHNba2V5XSA9PT0gJ2Z1bmN0aW9uJyB8fFxuICAgICAgICAgICAgdHlwZW9mIG1hcFN1YnNjcmlwdGlvbnNUb1Byb3BzW2tleV0gPT09ICdzdHJpbmcnKVxuICApO1xuXG4gIGlmICghdmFsaWRNYXBwZWRTdWJzY3JpcHRpb25zKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEV2ZXJ5IG1hcHBlZCBTdWJzY3JpcHRpb24gb2YgXCJjcmVhdGVQdWJTdWJDb25uZWN0b3JcIiBtdXN0IGJlIGEgZnVuY3Rpb25gXG4gICAgICArIGByZXR1cm5pbmcgdGhlIHZhbHVlIHRvIGJlIHBhc3NlZCBhcyBwcm9wIHRvIHRoZSBkZWNvcmF0ZWQgY29tcG9uZW50LmBcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIChwdWJTdWIsIG5vdGlmeUNoYW5nZSwgZ2V0UHJvcHMpID0+IHtcbiAgICBjb25zdCB7IGFkZCB9ID0gcHViU3ViO1xuICAgIGxldCBtYXAgPSB7fTtcblxuICAgIGNvbnN0IHVwZGF0ZVN0b3JlZE1hcEZyb21PYmplY3QgPSAodXBkYXRlZFZhbHVlKSA9PiB7XG4gICAgICBjb25zdCB1cGRhdGVkTWFwID0ge307XG4gICAgICBjb25zdCBrZXlzVG9VcGRhdGUgPSBPYmplY3Qua2V5cyh1cGRhdGVkVmFsdWUpXG4gICAgICAuZmlsdGVyKGtleSA9PiB7XG4gICAgICAgIGlmIChtYXAuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgIGlmICh1cGRhdGVkVmFsdWVba2V5XSAmJiBzaGFsbG93RXF1YWwobWFwW2tleV0sIHVwZGF0ZWRWYWx1ZVtrZXldKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB1cGRhdGVkTWFwW2tleV0gPSB1cGRhdGVkVmFsdWVba2V5XTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9KTtcblxuICAgICAgaWYgKGtleXNUb1VwZGF0ZS5sZW5ndGgpIHtcbiAgICAgICAgbWFwID0gY2xlYW5FbXB0eUtleXMoT2JqZWN0LmFzc2lnbih7fSwgbWFwLCB1cGRhdGVkTWFwKSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG5cbiAgICBjb25zdCB1cGRhdGVTdG9yZWRNYXBGcm9tS2V5ID0gKGtleSwgdXBkYXRlZFZhbHVlKSA9PiB7XG4gICAgICBpZiAobWFwLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgaWYgKHVwZGF0ZWRWYWx1ZSAmJiBzaGFsbG93RXF1YWwobWFwW2tleV0sIHVwZGF0ZWRWYWx1ZSkpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIG1hcCA9IGNsZWFuRW1wdHlLZXlzKE9iamVjdC5hc3NpZ24oe30sIG1hcCwgeyBba2V5XTogdXBkYXRlZFZhbHVlIH0pKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH07XG5cbiAgICBPYmplY3RcbiAgICAua2V5cyhtYXBTdWJzY3JpcHRpb25zVG9Qcm9wcylcbiAgICAuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgY29uc3QgdHJhbnNmb3JtZXJPckFsaWFzID0gbWFwU3Vic2NyaXB0aW9uc1RvUHJvcHNba2V5XTtcbiAgICAgIGlmICh0eXBlb2YgdHJhbnNmb3JtZXJPckFsaWFzID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGFkZChrZXksICguLi5hcmdzKSA9PiB7XG4gICAgICAgICAgY29uc3QgdXBkYXRlZFZhbHVlID0gdHJhbnNmb3JtZXJPckFsaWFzKC4uLmFyZ3MsIGdldFByb3BzKCkpO1xuICAgICAgICAgIGlmICh1cGRhdGVTdG9yZWRNYXBGcm9tT2JqZWN0KHVwZGF0ZWRWYWx1ZSkpIHtcbiAgICAgICAgICAgIG5vdGlmeUNoYW5nZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhZGQoa2V5LCBwYXlsb2FkID0+IHtcbiAgICAgICAgICBpZiAodXBkYXRlU3RvcmVkTWFwRnJvbUtleSh0cmFuc2Zvcm1lck9yQWxpYXMsIHBheWxvYWQpKSB7XG4gICAgICAgICAgICBub3RpZnlDaGFuZ2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuICgpID0+IG1hcDtcbiAgfTtcbn1cblxuZnVuY3Rpb24gd3JhcFB1Ymxpc2hNZXRob2RzKG1hcFB1Ymxpc2hUb1Byb3BzKSB7XG4gIHJldHVybiBwdWJsaXNoID0+IE9iamVjdC5rZXlzKG1hcFB1Ymxpc2hUb1Byb3BzKVxuICAuZmlsdGVyKGtleSA9PiB0eXBlb2YgbWFwUHVibGlzaFRvUHJvcHNba2V5XSA9PT0gJ2Z1bmN0aW9uJylcbiAgLnJlZHVjZSgoYWNjLCBrZXkpID0+IHtcbiAgICBhY2Nba2V5XSA9ICguLi5hcmdzKSA9PiBtYXBQdWJsaXNoVG9Qcm9wc1trZXldKHB1Ymxpc2gsIC4uLmFyZ3MpO1xuICAgIHJldHVybiBhY2M7XG4gIH0sIHt9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlUHViU3ViQ29ubmVjdG9yKFxuICBtYXBTdWJzY3JpcHRpb25zVG9Qcm9wcyxcbiAgbWFwUHVibGlzaFRvUHJvcHMsXG4gIG9wdGlvbnMgPSB7fVxuKSB7XG4gIGlmIChcbiAgICBtYXBTdWJzY3JpcHRpb25zVG9Qcm9wcyAmJlxuICAgICh0eXBlb2YgbWFwU3Vic2NyaXB0aW9uc1RvUHJvcHMgIT09ICdmdW5jdGlvbicgJiYgIWlzUGxhaW5PYmplY3QobWFwU3Vic2NyaXB0aW9uc1RvUHJvcHMpKVxuICApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgXCJjcmVhdGVQdWJTdWJDb25uZWN0b3JcIiBleHBlY3RlZCBcIm1hcFN1YnNjcmlwdGlvbnNUb1Byb3BzXCIgdG8gYmUgYSBmdW5jdGlvbmBcbiAgICAgICsgYCBvciBhIHBsYWluIG9iamVjdCwgaW5zdGVhZCByZWNlaXZlZDogJHttYXBTdWJzY3JpcHRpb25zVG9Qcm9wc30uYFxuICAgICk7XG4gIH1cbiAgY29uc3Qgc2hvdWxkTWFwU3Vic2NyaXB0aW9ucyA9IGlzUGxhaW5PYmplY3QobWFwU3Vic2NyaXB0aW9uc1RvUHJvcHMpID9cbiAgICBPYmplY3Qua2V5cyhtYXBTdWJzY3JpcHRpb25zVG9Qcm9wcykubGVuZ3RoIDogQm9vbGVhbihtYXBTdWJzY3JpcHRpb25zVG9Qcm9wcyk7XG5cbiAgbGV0IGZpbmFsTWFwU3Vic2NyaXB0aW9uc1RvUHJvcHMgPSBkZWZhdWx0TWFwU3Vic2NyaXB0aW9uc1RvUHJvcHM7XG4gIGxldCBkb1N1YnNjcmliZWRQcm9wc0RlcGVuZE9uT3duUHJvcHMgPSBmYWxzZTtcblxuXG4gIGNvbnN0IGZpbmFsTWFwUHVibGlzaFRvUHJvcHMgPSBpc1BsYWluT2JqZWN0KG1hcFB1Ymxpc2hUb1Byb3BzKSA/XG4gICAgd3JhcFB1Ymxpc2hNZXRob2RzKG1hcFB1Ymxpc2hUb1Byb3BzKSA6IG1hcFB1Ymxpc2hUb1Byb3BzIHx8IGRlZmF1bHRNYXBQdWJsaXNoVG9Qcm9wcztcbiAgY29uc3QgZG9QdWJsaXNoUHJvcHNEZXBlbmRPbk93blByb3BzID0gZmluYWxNYXBQdWJsaXNoVG9Qcm9wcy5sZW5ndGggPiAxO1xuXG4gIGNvbnN0IHsgd2l0aFJlZiA9IGZhbHNlIH0gPSBvcHRpb25zIHx8IHt9O1xuXG4gIGZ1bmN0aW9uIGluaXRDb21wdXRlU3Vic2NyaWJlZFByb3BzKHB1YlN1Yiwgbm90aWZpZXIsIGdldFByb3BzKSB7XG4gICAgbGV0IHN1YnNjcmliZXI7XG4gICAgaWYgKGlzUGxhaW5PYmplY3QobWFwU3Vic2NyaXB0aW9uc1RvUHJvcHMpKSB7XG4gICAgICBzdWJzY3JpYmVyID0gd3JhcFN1YnNjcml0aW9uc01hcChtYXBTdWJzY3JpcHRpb25zVG9Qcm9wcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN1YnNjcmliZXIgPSBtYXBTdWJzY3JpcHRpb25zVG9Qcm9wcyB8fCBkZWZhdWx0SW5pdE1hcFN1YnNjcmlwdGlvbnNUb1Byb3BzO1xuICAgIH1cbiAgICBmaW5hbE1hcFN1YnNjcmlwdGlvbnNUb1Byb3BzID0gc3Vic2NyaWJlcihwdWJTdWIsIG5vdGlmaWVyLCBnZXRQcm9wcyk7XG4gICAgZG9TdWJzY3JpYmVkUHJvcHNEZXBlbmRPbk93blByb3BzID0gZmluYWxNYXBTdWJzY3JpcHRpb25zVG9Qcm9wcy5sZW5ndGggPiAwO1xuICB9XG5cbiAgZnVuY3Rpb24gY29tcHV0ZVN1YnNjcmliZWRQcm9wcyhwcm9wcykge1xuICAgIGNvbnN0IHN1YnNjcmliZWRQcm9wcyA9IGRvU3Vic2NyaWJlZFByb3BzRGVwZW5kT25Pd25Qcm9wcyA/XG4gICAgICBmaW5hbE1hcFN1YnNjcmlwdGlvbnNUb1Byb3BzKHByb3BzKSA6IGZpbmFsTWFwU3Vic2NyaXB0aW9uc1RvUHJvcHMoKTtcblxuICAgIGlmICghaXNQbGFpbk9iamVjdChzdWJzY3JpYmVkUHJvcHMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGAnbWFwU3Vic2NyaXB0aW9uc1RvUHJvcHMnIG11c3QgcmV0dXJuIGFuIG9iamVjdC5gXG4gICAgICAgICsgYEluc3RlYWQgcmVjZWl2ZWQgJHtzdWJzY3JpYmVkUHJvcHN9YFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHN1YnNjcmliZWRQcm9wcztcbiAgfVxuXG4gIGZ1bmN0aW9uIGNvbXB1dGVQdWJsaXNoUHJvcHMocHViU3ViLCBwcm9wcykge1xuICAgIGNvbnN0IHsgcHVibGlzaCB9ID0gcHViU3ViO1xuICAgIGNvbnN0IHB1Ymxpc2hQcm9wcyA9IGRvUHVibGlzaFByb3BzRGVwZW5kT25Pd25Qcm9wcyA/XG4gICAgICBmaW5hbE1hcFB1Ymxpc2hUb1Byb3BzKHB1Ymxpc2gsIHByb3BzKSA6IGZpbmFsTWFwUHVibGlzaFRvUHJvcHMocHVibGlzaCk7XG5cbiAgICBpZiAoIWlzUGxhaW5PYmplY3QocHVibGlzaFByb3BzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgJ21hcFB1Ymxpc2hUb1Byb3BzJyBtdXN0IHJldHVybiBhbiBvYmplY3QuYFxuICAgICAgICArIGBJbnN0ZWFkIHJlY2VpdmVkICR7cHVibGlzaFByb3BzfWBcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBwdWJsaXNoUHJvcHM7XG4gIH1cblxuICByZXR1cm4gZnVuY3Rpb24gd3JhcENvbXBvbmVudChDb21wb3NlZCkge1xuICAgIGNsYXNzIFB1YlN1YkNvbm5lY3RvciBleHRlbmRzIENvbXBvbmVudCB7XG5cbiAgICAgIGNvbnN0cnVjdG9yKHByb3BzLCBjb250ZXh0KSB7XG4gICAgICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KTtcbiAgICAgICAgdGhpcy5wdWJTdWJDb3JlID0gcHJvcHMucHViU3ViQ29yZSB8fCBjb250ZXh0LnB1YlN1YkNvcmU7XG5cbiAgICAgICAgaWYgKCF0aGlzLnB1YlN1YkNvcmUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQ291bGQgbm90IGZpbmQgXCJwdWJTdWJDb3JlXCIgaW4gZWl0aGVyIHRoZSBjb250ZXh0IG9yIGBcbiAgICAgICAgICAgICsgYHByb3BzIG9mIFwiJHt0aGlzLmNvbnN0cnVjdG9yLmRpc3BsYXlOYW1lfVwiLiBgXG4gICAgICAgICAgICArIGBFaXRoZXIgd3JhcCB0aGUgcm9vdCBjb21wb25lbnQgaW4gYSA8UHViU3ViUHJvdmlkZXI+LCBgXG4gICAgICAgICAgICArIGBvciBleHBsaWNpdGx5IHBhc3MgXCJwdWJTdWJDb3JlXCIgYXMgYSBwcm9wIHRvIFwiJHt0aGlzLmNvbnN0cnVjdG9yLmRpc3BsYXlOYW1lfVwiLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7fTtcbiAgICAgICAgdGhpcy5wdWJTdWIgPSB0aGlzLnB1YlN1YkNvcmUucmVnaXN0ZXIodGhpcyk7XG4gICAgICB9XG5cbiAgICAgIGNvbXBvbmVudFdpbGxNb3VudCgpIHtcbiAgICAgICAgdGhpcy50cnlTdWJzY3JpYmUoKTtcbiAgICAgIH1cblxuICAgICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHMpIHtcbiAgICAgICAgaWYgKCFzaGFsbG93RXF1YWwobmV4dFByb3BzLCB0aGlzLnByb3BzKSkge1xuICAgICAgICAgIHRoaXMuaGF2ZU93blByb3BzQ2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXZlT3duUHJvcHNDaGFuZ2VkIHx8IHRoaXMuaGFzU3Vic2NyaWJlZFByb3BzQ2hhbmdlZDtcbiAgICAgIH1cblxuICAgICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMucHViU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgICB9XG5cbiAgICAgIGdldFdyYXBwZWRJbnN0YW5jZSgpIHtcbiAgICAgICAgaWYgKCF3aXRoUmVmKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYFRvIGFjY2VzcyB0aGUgd3JhcHBlZCBpbnN0YW5jZSwgeW91IG5lZWQgdG8gc3BlY2lmeSBleHBsaWNpdGx5YFxuICAgICAgICAgICAgKyBgIHsgd2l0aFJlZjogdHJ1ZSB9IGluIHRoZSBvcHRpb25zIHBhc3NlZCB0byB0aGUgY3JlYXRlUHViU3ViQ29ubmVjdG9yKCkgY2FsbC5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5yZWZzLndyYXBwZWRJbnN0YW5jZTtcbiAgICAgIH1cblxuICAgICAgaGFzU3Vic2NyaXB0aW9ucygpIHtcbiAgICAgICAgaWYgKHRoaXMucHViU3ViKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMucHViU3ViLnN1YnNjcmlwdGlvbnMubGVuZ3RoID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgbm90aWZ5Q2hhbmdlKCkge1xuICAgICAgICBjb25zdCBwcmV2U3Vic2NyaWJlZFByb3BzID0gdGhpcy5zdGF0ZS5zdWJzY3JpYmVkUHJvcHM7XG4gICAgICAgIGNvbnN0IHN1YnNjcmliZWRQcm9wcyA9IGZpbmFsTWFwU3Vic2NyaXB0aW9uc1RvUHJvcHModGhpcy5wcm9wcyk7XG5cbiAgICAgICAgaWYgKHByZXZTdWJzY3JpYmVkUHJvcHMgIT09IHN1YnNjcmliZWRQcm9wcykge1xuICAgICAgICAgIHRoaXMuaGFzU3Vic2NyaWJlZFByb3BzQ2hhbmdlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHN1YnNjcmliZWRQcm9wcyB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0cnlTdWJzY3JpYmUoKSB7XG4gICAgICAgIGlmIChzaG91bGRNYXBTdWJzY3JpcHRpb25zKSB7XG4gICAgICAgICAgaW5pdENvbXB1dGVTdWJzY3JpYmVkUHJvcHMoXG4gICAgICAgICAgICB0aGlzLnB1YlN1YiwgKCkgPT4gdGhpcy5ub3RpZnlDaGFuZ2UoKSwgKCkgPT4gdGhpcy5wcm9wc1xuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5ub3RpZnlDaGFuZ2UoKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB1cGRhdGVTdWJzY3JpYmVkUHJvcHNJZk5lZWRlZCgpIHtcbiAgICAgICAgY29uc3QgbmV4dFN1YnNjcmliZWRQcm9wcyA9IGNvbXB1dGVTdWJzY3JpYmVkUHJvcHModGhpcy5wcm9wcyk7XG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmliZWRQcm9wcyAmJiBzaGFsbG93RXF1YWwobmV4dFN1YnNjcmliZWRQcm9wcywgdGhpcy5zdWJzY3JpYmVkUHJvcHMpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zdWJzY3JpYmVkUHJvcHMgPSBuZXh0U3Vic2NyaWJlZFByb3BzO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgdXBkYXRlUHVibGlzaFByb3BzSWZOZWVkZWQoKSB7XG4gICAgICAgIGNvbnN0IG5leHRQdWJsaXNoUHJvcHMgPSBjb21wdXRlUHVibGlzaFByb3BzKHRoaXMucHViU3ViLCB0aGlzLnByb3BzKTtcbiAgICAgICAgaWYgKHRoaXMucHVibGlzaFByb3BzICYmIHNoYWxsb3dFcXVhbChuZXh0UHVibGlzaFByb3BzLCB0aGlzLnB1Ymxpc2hQcm9wcykpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnB1Ymxpc2hQcm9wcyA9IG5leHRQdWJsaXNoUHJvcHM7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICBoYXZlT3duUHJvcHNDaGFuZ2VkLFxuICAgICAgICAgIGhhc1N1YnNjcmliZWRQcm9wc0NoYW5nZWQsXG4gICAgICAgICAgcmVuZGVyZWRFbGVtZW50LFxuICAgICAgICAgIHB1YlN1YixcbiAgICAgICAgfSA9IHRoaXM7XG5cbiAgICAgICAgdGhpcy5oYXZlT3duUHJvcHNDaGFuZ2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuaGFzU3Vic2NyaWJlZFByb3BzQ2hhbmdlZCA9IGZhbHNlO1xuXG4gICAgICAgIGxldCBzaG91bGRVcGRhdGVTdWJzY3JpYmVkUHJvcHMgPSB0cnVlO1xuICAgICAgICBsZXQgc2hvdWxkVXBkYXRlUHVibGlzaFByb3BzID0gdHJ1ZTtcbiAgICAgICAgaWYgKHJlbmRlcmVkRWxlbWVudCkge1xuICAgICAgICAgIHNob3VsZFVwZGF0ZVN1YnNjcmliZWRQcm9wcyA9IGhhc1N1YnNjcmliZWRQcm9wc0NoYW5nZWQgfHxcbiAgICAgICAgICAgIChoYXZlT3duUHJvcHNDaGFuZ2VkICYmIGRvU3Vic2NyaWJlZFByb3BzRGVwZW5kT25Pd25Qcm9wcyk7XG4gICAgICAgICAgc2hvdWxkVXBkYXRlUHVibGlzaFByb3BzID0gaGF2ZU93blByb3BzQ2hhbmdlZCAmJiBkb1B1Ymxpc2hQcm9wc0RlcGVuZE9uT3duUHJvcHM7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaGF2ZVN1YnNjcmliZWRQcm9wc0NoYW5nZWQgPSBmYWxzZTtcbiAgICAgICAgbGV0IGhhdmVQdWJsaXNoUHJvcHNDaGFuZ2VkID0gZmFsc2U7XG4gICAgICAgIGlmIChzaG91bGRVcGRhdGVTdWJzY3JpYmVkUHJvcHMpIHtcbiAgICAgICAgICBoYXZlU3Vic2NyaWJlZFByb3BzQ2hhbmdlZCA9IHRoaXMudXBkYXRlU3Vic2NyaWJlZFByb3BzSWZOZWVkZWQoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2hvdWxkVXBkYXRlUHVibGlzaFByb3BzKSB7XG4gICAgICAgICAgaGF2ZVB1Ymxpc2hQcm9wc0NoYW5nZWQgPSB0aGlzLnVwZGF0ZVB1Ymxpc2hQcm9wc0lmTmVlZGVkKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXG4gICAgICAgICAgIWhhdmVTdWJzY3JpYmVkUHJvcHNDaGFuZ2VkICYmXG4gICAgICAgICAgIWhhdmVQdWJsaXNoUHJvcHNDaGFuZ2VkICYmXG4gICAgICAgICAgIWhhdmVPd25Qcm9wc0NoYW5nZWQgJiZcbiAgICAgICAgICByZW5kZXJlZEVsZW1lbnRcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuIHJlbmRlcmVkRWxlbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJhc2VQcm9wcyA9IHsgcHViU3ViIH07XG4gICAgICAgIGlmICh3aXRoUmVmKSB7XG4gICAgICAgICAgT2JqZWN0LmFzc2lnbihiYXNlUHJvcHMsIHsgcmVmOiAnd3JhcHBlZEluc3RhbmNlJyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1lcmdlZFByb3BzID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAgICB7fSxcbiAgICAgICAgICB0aGlzLnByb3BzLFxuICAgICAgICAgIHRoaXMuc3Vic2NyaWJlZFByb3BzLFxuICAgICAgICAgIHRoaXMucHVibGlzaFByb3BzLFxuICAgICAgICAgIGJhc2VQcm9wc1xuICAgICAgICApO1xuXG4gICAgICAgIHRoaXMucmVuZGVyZWRFbGVtZW50ID0gY3JlYXRlRWxlbWVudChDb21wb3NlZCwgbWVyZ2VkUHJvcHMpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnJlbmRlcmVkRWxlbWVudDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBQdWJTdWJDb25uZWN0b3IuY29udGV4dFR5cGVzID0ge1xuICAgICAgcHViU3ViQ29yZTogcHViU3ViU2hhcGUsXG4gICAgfTtcblxuICAgIFB1YlN1YkNvbm5lY3Rvci5wcm9wVHlwZXMgPSB7XG4gICAgICBwdWJTdWJDb3JlOiBwdWJTdWJTaGFwZSxcbiAgICB9O1xuXG4gICAgUHViU3ViQ29ubmVjdG9yLmRpc3BsYXlOYW1lID0gYFB1YlN1YkNvbm5lY3Rvcigke2dldERpc3BsYXlOYW1lKENvbXBvc2VkKX0pYDtcbiAgICBQdWJTdWJDb25uZWN0b3IuV3JhcHBlZENvbXBvbmVudCA9IENvbXBvc2VkO1xuXG4gICAgcmV0dXJuIGhvaXN0U3RhdGljcyhQdWJTdWJDb25uZWN0b3IsIENvbXBvc2VkKTtcbiAgfTtcbn1cbiJdfQ==